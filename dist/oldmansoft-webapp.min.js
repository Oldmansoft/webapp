if(!window.oldmansoft){window.oldmansoft={}}window.oldmansoft.webapp=new (function(){var e=this,d,b,c,a,f;d={loadType:{get:"GET",post:"POST"}};b={setting:{timeover:180000,loading_show_time:1000,loading_hide_time:200,server_charset:"utf-8"},text:{ok:"Ok",yes:"Yes",no:"No",loading:"Loading",load_layout_error:"load layout error, click Ok to reload."}};c={delay:function(){var g=[];function h(i){if(g[i]){return g[i]}g[i]={read:false,list:null};return g[i]}this.ready=function(k){if(h(k).ready){return}h(k).ready=true;var l=h(k).list,j;if(!l){return}for(j=0;j<l.length;j++){l[j]()}h(k).list=null};this.reset=function(i){delete g[i]};this.execute=function(i,j){if(h(i).ready){j()}else{if(!h(i).list){h(i).list=[]}h(i).list.push(j)}}},loader:function(){var g=[];function i(l,k,j){if(l.length==k+1){j.resolve()}else{h(l,k+1,j)}}function h(l,k,j){if(g[l[k]]){i(l,k,j);return}$.getScript(l[k],function(){g[l[k]]=true;i(l,k,j)})}this.script=function(){var j=$.Deferred();if(arguments.length==0){j.resolve()}else{h(arguments,0,j)}return j}},action:function(){var g=[];this.add=function(h){if(typeof(h)!="function"){throw new Error("fn is not a function")}g.push(h)};this.execute=function(){var j=Array.from(arguments),k,h;for(k=0;k<g.length;k++){h=g[k].apply(null,j);if(h!=undefined){return h}}};this.copyTo=function(j){var h;for(h=0;h<g.length;h++){j.add(g[h])}}},actionEvent:function(){this.before=new c.action();this.after=new c.action();this.completed=new c.action()},scrollBar:function(A){if(!A){return}var t,v,p,s,k,i,B,n,r,m,z=true;function h(C,D){if(C.selector=="body"){if(D!=undefined){$(document).scrollTop(D)}else{return $(document).scrollTop()}}else{if(D!=undefined){C.scrollTop(D)}else{return C.scrollTop()}}}function g(E){var D,C;isSetTrackPosition=false;this.contentHeight=function(){return D};this.viewHeight=function(){return C};this.setHeight=function(){D=E.scrollHeight;C=window.innerHeight};this.setTrackPosition=function(F){if(isSetTrackPosition){return true}F.css("right",0);F.css("top",0);isSetTrackPosition=true;return true};this.bindMouseWheel=function(){$(window).on("mousewheel",q)};this.unbindMouseWheel=function(){$(window).off("mousewheel",q)}}function w(F,E){var D,C;this.contentHeight=function(){return D};this.viewHeight=function(){return C};this.setHeight=function(){D=E.scrollHeight;C=F.innerHeight()};this.setTrackPosition=function(){return false};this.bindMouseWheel=function(){F.on("mousewheel",q)};this.unbindMouseWheel=function(){F.off("mousewheel",q)}}function y(){var C=(v.viewHeight()-B)*h(A)/(v.contentHeight()-v.viewHeight());i.css("top",C)}function q(F){var E=F.target,G=F.originalEvent.wheelDelta,D,C;while(E!=F.currentTarget&&E!=null&&E.tagName!="HTML"&&E.tagName!="BODY"){C=E.style.overflowY;if((C=="auto"||C=="scroll")&&E.clientHeight!=E.scrollHeight){if(G>0&&E.scrollTop>0){return true}if(G<0&&E.scrollTop+E.clientHeight<E.scrollHeight){return true}}E=E.parentElement}if(v.contentHeight()<=v.viewHeight()){return true}D=h(A);if(G<0){if(D>=(v.contentHeight()-v.viewHeight())){return true}}else{if(D==0){return true}}h(A,D-G);y();return false}function l(){return false}function o(C){m=C.clientY;r=h(A);n.on("selectstart",l);n.on("mousemove",j);n.on("mouseup",u);s.addClass("focus")}function u(){n.off("selectstart",l);n.off("mousemove",j);n.off("mouseup",u);s.removeClass("focus")}function j(D){var C=(v.contentHeight()-v.viewHeight())/(v.viewHeight()-B);h(A,r-(m-D.clientY)*C);y()}function x(){v.setHeight();if(v.viewHeight()==0||v.contentHeight()<=v.viewHeight()){s.hide();return}else{s.show()}s.height(v.viewHeight());if(!v.setTrackPosition(s)){s.css("left",A.innerWidth()-parseInt(A.css("padding-left"))-k);s.css("top",-parseInt(A.css("padding-top")))}B=s.height()*v.viewHeight()/v.contentHeight();if(B<20){B=20}i.height(B);y()}A=$(A);t=A.get(0);v=t.tagName=="BODY"?new g(t):new w(A,t);n=$("html");A.css("overflow","hidden");p=$("<div></div>").addClass("scrollbar-container");s=$("<div></div>").addClass("scrollbar-track");i=$("<div></div>").addClass("scrollbar-arrow");p.append(s);s.append(i);A.prepend(p);k=s.width();x();s.mousedown(o);$(window).on("resize",x);v.bindMouseWheel();this.show=function(){if(z){return}p.show();v.bindMouseWheel();z=true};this.hide=function(){if(!z){return}v.unbindMouseWheel();p.hide();z=false};this.reset=function(){x()}},shield:function(h,l,g,i){var k=$("<div></div>").addClass("box-background"),j={close:new c.actionEvent()};function m(n){j.close.before.execute();k.stop(true);k.fadeOut(200,function(){j.close.after.execute();k.remove();e.bodyManagement.shrink();j.close.completed.execute();if(n){n()}})}if(i){k.addClass(i)}if(g){k.append($("<div></div>").addClass("layout-center").append($("<div></div>").addClass("layout-center-content").append(l)))}else{k.append(l)}e.bodyManagement.expand();if($(h).length==0){$("body").prepend($("<div></div>").addClass(h.replace(".","")))}$(h).append(k);k.on("scroll",e.refresh);k.fadeIn(200);this.close=function(o,n){if(o&&o.target!=o.currentTarget){return}m(n)};this.change=function(n){if(g){k.children().children().empty().append(n)}else{k.empty().append(n)}};this.click=function(n){k.on("click",n)};this.event=function(){return j}},view:function(i,n,j,l,o){var k=$("<div></div>").addClass("view").addClass(i+"-view"),p=new c.viewEvent_parameter(i,n,j,k),h={loaded:false,actived:false},g={view:null,load:new c.actionEvent(),unload:new c.actionEvent()},m={};function q(s){var r=s.data?d.loadType.post:d.loadType.get;h.loaded=true;g.view=new c.viewEvent();f.event.loadedView=g.view;if(o==undefined){g.load.before.execute(s);a.load(s.node,j?j:f.defaultHref,s.data,r).done(function(){g.load.after.execute(s);f.event.globalView.copyTo(f.event.loadedView);f.event.loadedView.load.execute(p);s.active();g.load.completed.execute(s)})}else{s.node.append(o);f.event.globalView.copyTo(f.event.loadedView);f.event.loadedView.load.execute(p);s.active()}}this.name=i;this.index=n;this.href=j;this.data=l;this.node=k;this.unload=function(){g.unload.before.execute(this);if(h.actived){g.view.inactive.execute(p);h.actived=false}if(h.loaded){g.view.unload.execute(p);h.loaded=false}g.unload.after.execute(this);this.node.remove();this.href=undefined;g.unload.completed.execute(this);return this};this.active=function(){if(!h.loaded){q(this);return this}if(h.actived){return this}this.node.show();e.resetWindowScrollBar();g.view.active.execute(p);h.actived=true;return this};this.inactive=function(r){if(!h.actived){return this}g.view.inactive.execute(p);if(r){this.node.hide()}h.actived=false;return this};this.event=function(r){if(r){g=r.event()}return g};this.attach=function(r,s){if(s==undefined){return m[r]}m[r]=s;return this};this.state=function(){return{loaded:h.loaded,actived:h.actived}}},viewEvent_parameter:function(i,h,g,j){this.name=i;this.index=h;this.href=g;this.node=j},viewEvent:function(){this.load=new c.action();this.unload=new c.action();this.active=new c.action();this.inactive=new c.action();this.copyTo=function(g){this.load.copyTo(g.load);this.unload.copyTo(g.unload);this.active.copyTo(g.active);this.inactive.copyTo(g.inactive)}},viewManager:function(){var g=[];this.add=function(h){g.push(h);return h};this.count=function(){return g.length};this.get=function(h){return g[h]};this.last=function(){if(g.length==0){return null}return g[g.length-1]};this.pop=function(){return g.pop()};this.clear=function(){var h=g;g=[];return h}},mainViewer:function(h){var j="main",i=new c.viewManager();function g(l){var k=new c.view(j,l.length-1,l[l.length-1]);k.event().load.after.add(function(){var m;for(m=i.count()-1;m>l.length-1;m--){i.pop().unload()}for(m=0;m<l.length-1;m++){if(m<i.count()){if(i.get(m).href==l[m]){i.get(m).inactive(true)}else{i.get(m).unload()}}else{i.add(new c.view(j,m,l[m]))}}if(l.length==i.count()){i.pop().unload()}i.add(k);$(h).append(k.node)});k.event().load.completed.add(function(){e.linker.callChangeCompleted(true)});k.active()}this.getView=function(){return i.last()};this.replaceLastView=function(k){i.pop().unload();i.add(k);$(h).append(k.node);k.active()};this.close=function(){e.linker.back();return new function(){this.completed=function(k){e.linker.setChangeCompleted(k)}}};this.reload=function(l){var k=new c.view(j,i.count()-1,i.last().href);k.event().load.after.add(function(){i.pop().unload();i.add(k);$(h).append(k.node);if(typeof(l)=="function"){l()}});k.active()};this.redirect=function(k){e.linker.same(k)};this.linkerChange=function(m){var n=new a.linkParser(m).getHrefs(),l,k;e.dialog.clear();f.viewer.window.clear();if(n.length>=i.count()){g(n);return}k=i.get(n.length-1);if(k.href!=n[n.length-1]||!k.state().loaded){g(n);return}for(l=i.count()-1;l>n.length-1;l--){i.pop().unload()}for(l=0;l<n.length-1;l++){if(i.get(l).href==n[l]){continue}i.get(l).unload()}i.last().active();e.linker.callChangeCompleted(false)}},windowViewer:function(){var g=new c.viewManager();function h(i){this.closed=function(l){var j,k;if(typeof(l)!="function"){throw new Error("fn is not a function")}i.attach("closed",l);if(arguments.length>1){j=[];for(k=1;k<arguments.length;k++){j.push(arguments[k])}i.attach("argus",j)}return this};this.loaded=function(j){if(typeof(j)!="function"){throw new Error("fn is not a function")}i.attach("loaded",j);return this};this.force=function(){i.attach("force",true);return this}}this.getView=function(){return g.last()};this.replaceLastView=function(i){g.pop().unload();g.add(i);i.attach("shield").change(i.node);i.active()};this.close=function(){var i=Array.from(arguments),j=new c.action();g.last().attach("shield").close(null,function(){var k=g.pop().unload();if(g.count()==0){f.viewer.manager.pop()}else{g.last().active()}if(k.attach("closed")){if(k.attach("argus")){i=k.attach("argus").concat(i)}k.attach("closed").apply(null,i)}j.execute()});return new function(){this.completed=function(k){j.add(k)}}};this.reload=function(k){var j=g.last(),i=new c.view(j.name,j.index,j.href,j.data);i.attach("shield",j.attach("shield"));i.event().load.after.add(function(){g.pop().unload();g.add(i);i.attach("shield").change(i.node);if(typeof(k)=="function"){k()}});i.active()};this.redirect=function(j,l){var k=g.last(),i=new c.view(k.name,k.index,j,l);i.attach("shield",k.attach("shield"));i.event().load.after.add(function(){g.pop().unload();g.add(i);i.attach("shield").change(i.node)});i.active()};this.open=function(j,k){var i=new c.view("open",g.count(),j,k);i.event().load.after.add(function(){if(g.count()==0){f.viewer.manager.push(f.viewer.window)}else{g.last().inactive()}g.add(i);i.attach("shield",new c.shield(".window-ares",i.node,false,"window-background"));if(i.attach("loaded")){i.attach("loaded")()}});i.active();return new h(i)};this.modal=function(j,k){var i=new c.view("modal",g.count(),j,k);i.node.addClass("box-panel");i.event().load.after.add(function(){var l;if(g.count()==0){f.viewer.manager.push(f.viewer.window)}else{g.last().inactive()}g.add(i);l=new c.shield(".window-ares",i.node,true,"window-background");if(!i.attach("force")){l.click(function(){l.close(null,function(){var m=g.pop().unload();if(g.count()==0){f.viewer.manager.pop()}else{g.last().active()}if(m.attach("closed")){if(m.attach("argus")){m.attach("closed").apply(null,m.attach("argus"))}else{m.attach("closed")()}}})})}i.attach("shield",l);if(i.attach("loaded")){i.attach("loaded")()}});i.active();return new h(i)};this.clear=function(){var k=g.clear(),j;if(k.length==0){return}for(j=k.length-1;j>-1;j--){k[j].attach("shield").close()}f.viewer.manager.pop()}},viewerManager:function(){var h,g=[];this.push=function(i){g.push(h);if(h){h.getView().inactive()}h=i};this.get=function(){return h};this.pop=function(){if(g.length==1){throw new Error("error call")}h=g.pop();h.getView().active();return h}},innerViewer:function(){var h="inner";function g(){var i=[];this.set=function(j,k){i[j]=k};this.unload=function(){for(var j in i){if(!i[j]){continue}i[j].unload()}};this.inactive=function(){for(var j in i){if(!i[j]){continue}i[j].inactive()}}}this.name=h;this.load=function(i,k){var l=e.currentViewNodeFind(i),j;if(l.length==0){return}j=new c.view(h,0,k);j.event().load.after.add(function(){var n=f.viewer.manager.get().getView(),m=new g();if(l.data("view")){l.data("view").unload()}l.data("view",j);l.append(j.node);if(!n.attach("inner")){n.attach("inner",m);f.viewer.manager.get().getView().event().view.inactive.add(function(){m.inactive()});f.viewer.manager.get().getView().event().view.unload.add(function(){m.unload()})}n.attach("inner").set("selector",j)});j.active()};this.replaceLastView=function(i,j){var k=e.currentViewNodeFind(i),l;if(k.length==0){return}l=f.viewer.manager.get().getView(),inner=new g();if(k.data("view")){k.data("view").unload()}k.data("view",j);k.append(j.node);if(!l.attach("inner")){l.attach("inner",inner);f.viewer.manager.get().getView().event().view.inactive.add(function(){inner.inactive()});f.viewer.manager.get().getView().event().view.unload.add(function(){inner.unload()})}l.attach("inner").set("selector",j);j.active()}},dealTouchMove:function(k){var j,h,g=true;if($("body").hasClass("layout-expanded")){j=k.originalEvent.path;if(!j){return}for(h=0;h<j.length;h++){if(j[h].tagName=="BODY"){break}if(j[h].scrollHeight>j[h].clientHeight){g=false;break}}if(g){k.preventDefault()}}}};a={linkParser:function(j){var h=[],l,k;function g(i){if(!i){return""}if(i.substr(0,1)=="#"){return i.substr(1)}return i}this.getHrefs=function(){return h.slice()};this.count=function(){return h.length};this.add=function(i){return h.push(g(i))};this.pop=function(){return h.pop()};this.last=function(i){if(i){h[h.length-1]=g(i);return}return h[h.length-1]};this.getHash=function(){var m=[],n;for(n=0;n<h.length;n++){m.push(e.linkEncode(h[n]))}return m.join("_")};if(arguments.length==0){return}if(j instanceof Array){h=j.slice()}else{l=g(j);if(l.indexOf("#")>-1||l.indexOf("%23")>-1){h=l.replace(/%23/g,"#").split("#")}else{h=l.split("_");for(k=0;k<h.length;k++){h[k]=e.linkDecode(h[k])}}}},isHtmlDocument:function(h){var g,i;if(!h){return false}for(g=0;g<h.length;g++){i=h.substr(g,1);if(i==" "){continue}if(i=="\r"){continue}if(i=="\n"){continue}if(i=="\t"){continue}break}if(h.substr(g,15)=="<!DOCTYPE html>"){return true}if(h.substr(g,5)=="<html"){return true}return false},load:function(l,g,m,k){var j=new c.action(),i=new c.action(),n;function h(){this.done=function(o){j.add(o)};this.fail=function(o){i.add(o)}}if(f.hideMainViewFirstLoadingTips){f.hideMainViewFirstLoadingTips=false}else{n=e.loadingTip.show()}$.ajax({mimeType:"text/html; charset="+b.setting.server_charset,url:g,data:m,type:k,timeout:b.setting.timeover}).done(function(r,s,q){if(n){n.hide()}var p=q.getResponseHeader("X-Responded-JSON"),o;if(p){o=JSON.parse(p);if(o.status==401){if(f.event.unauthorized.execute(g,o.headers?o.headers.location:null)!==false){if(o.headers&&o.headers.location){document.location=o.headers.location}}}}if(a.isHtmlDocument(r)){alert("You try to load wrong content: "+g);return}l.html(r);j.execute();e.refresh()}).fail(function(q,t,r){var o,s,p;if(n){n.hide()}if(q.status==401){if(f.event.unauthorized.execute(g)===false){return}}else{if(q.status==0&&t=="timeout"){f.event.loadTimeout.execute(l);return}}o=$(q.responseText);s=$("<h4></h4>").text(r);p=$("<pre></pre>");if(o[11]!=null&&o[11].nodeType==8){p.text(o[11].data)}else{p.text(o.eq(1).text())}l.append(s).append(p);i.execute()});return new h()},deal:{json:function(g){var h=g.text?g.text:g.Text;if(h){$app.alert(h).ok(function(){a.deal.close(g)})}else{a.deal.close(g)}},close:function(g){var h=g.off?g.off:g.Off;if(h){e.viewClose().completed(function(){a.deal.action(g)})}else{a.deal.action(g)}},action:function(h){var j=h.path?h.path:h.Path,i=h.data?h.data:h.Data,g=h.renew?h.renew:h.Renew;if(i){f.event.form.dealCustomized.execute(i)}if(j){$app.same(j)}else{if(g){$app.reload()}}}},click:function(i){var h=$(this).attr("target"),g=$(this).attr("href");if(g==undefined||(g.length>0&&g[0]=="#")){return}if(h=="_none"){return}if(!h){i.preventDefault();f.hrefTargetDealer._link(g);return}if(f.hrefTargetDealer[h]){i.preventDefault();f.hrefTargetDealer[h](g,$(this));return}if(h[0]!="_"){f.viewer.inner.load(h,g);i.preventDefault()}},verification:{required:function(g){var j=g[0].attr("type"),h;if(j=="checkbox"||j=="radio"){for(h=0;h<g.length;h++){if(g[h].prop("checked")){return true}}}else{for(h=0;h<g.length;h++){if($.trim(g[h].val())!=""){return true}}}return false},verify:function(k,g){if(!k){return true}var j=k.split(" "),h;for(h=0;h<j.length;h++){if(j[h]==""){continue}if(a.verification[j[h]](g)===false){return false}}return true}},form:{serialize:function(h){var g=[];h.forEach(function(j,i){if(typeof(j)!="string"){return}g.push(encodeURIComponent(i)+"="+encodeURIComponent(j))});return g.join("&")},image:function(){function k(t){var i=t.split(","),v=i[0].match(/:(.*?);/)[1],s=atob(i[1]),w=s.length,u=new Uint8Array(w);while(w--){u[w]=s.charCodeAt(w)}return new Blob([u],{type:v})}function p(t,s,i,u){if(!$(t).data("images")){$(t).data("images",[])}$(t).data("images").push({blob:i,name:s.name});if($(t).data("images").length==t.files.length){u.close();$(t).trigger("dealt")}}function g(t,s,x,u,i,v){var w=new Image();w.onload=function(){var A,y,z;if(w.width<=u&&w.height<=i){z=s}else{A=document.createElement("canvas");y=A.getContext("2d");if(w.width>=w.height&&w.width>u){w.height*=u/w.width;w.width=u}else{if(w.width<=w.height&&w.height>i){w.width*=i/w.height;w.height=i}}A.width=w.width;A.height=w.height;y.drawImage(w,0,0,w.width,w.height);z=s.type=="image/jpeg"?k(A.toDataURL("image/jpeg",0.95)):k(A.toDataURL(s.type))}p(t,s,z,v)};w.src=x}var o,h,q,j,r,n,m,l=this;o=$(this).attr("data-image");if(!o){return}o=o.split("x");if(o.length!=2){return}h=Number(o[0]);q=Number(o[1]);if(isNaN(h)||h<1||isNaN(q)||q<1){return}$(this).trigger("dealing");$(this).data("images",null);if(this.files.length==0){$(this).trigger("dealt");return}r=$app.message("图片处理中");for(m=0;m<this.files.length;m++){j=this.files[m];if(!j.type.match(/image.*/)){p(this,j,j,r);continue}n=new FileReader();n.onload=function(i){g(l,j,i.target.result,h,q,r)};n.readAsDataURL(j)}},verify:function(h){function g(){var j=true,k=[],i;h.find("[data-verify]").each(function(){var l=$(this),m=l.attr("name");if(!m){m=l.attr("data-input")}if(!m){return}if(!k[m]){k[m]={verify:l.attr("data-verify"),input:[]}}if(!h.data("verify")){l.on("change",g)}k[m].input.push(l)});for(i in k){if(!a.verification.verify(k[i].verify,k[i].input)){j=false;break}}if(!h.data("verify")){h.data("verify",true);h.on("change",g)}if(j){h.removeClass("not-ready")}else{h.addClass("not-ready")}if(f.event.form.verify.completed.execute(h,j)===false){return false}return j}if(f.event.form.verify.before.execute(h)===false){return false}return g()},getFormData:function(g){var h=new FormData();g.find("input[type!=file]").each(function(){var i=$(this),j=i.attr("name"),k=i.attr("type");if(!j||i.prop("readonly")||i.prop("disabled")){return}if(k=="checkbox"||k=="radio"){if(!i.prop("checked")){return}}h.append(j,$.trim(i.val()))});g.find("input[type=file]").each(function(){var k=$(this),l=k.attr("name"),j=k.data("images"),n,m;if(!l||k.prop("readonly")||k.prop("disabled")){return}if(j){for(m=0;m<j.length;m++){n=j[m];if(!n){continue}h.append(l,n.blob,n.name)}}else{if(this.files.length==0){h.append(l,new Blob([],{type:"application/octet-stream"}),"")}for(m=0;m<this.files.length;m++){h.append(l,this.files[m],this.files[m].name)}}});g.find("select").each(function(){var i=$(this),j=i.attr("name");if(!j||i.prop("readonly")||i.prop("disabled")){return}h.append(j,i.val())});g.find("textarea").each(function(){var i=$(this),j=i.attr("name");if(!j||i.prop("readonly")||i.prop("disabled")){return}h.append(j,$.trim(i.val()))});return h},submit:function(){var g=$(this),h=g.attr("action"),j=a.form.getFormData(g),i=g.attr("target"),l,k;k=f.event.form.submit.before.execute(g);if(k===false){return false}if(k===true){return}if(i=="_none"){return}if(i=="_blank"){return}if(!a.form.verify(g)){return false}if(i=="_open"){$app.open(h,a.form.serialize(j));return false}if(i&&i[0]!="_"&&e.currentViewNodeFind(i).length==0){return}l=e.loadingTip.show();$.ajax({url:h?h:f.defaultHref,data:j,type:d.loadType.post,contentType:false,processData:false}).done(function(r,s,q){l.hide();var p=q.getResponseHeader("X-Responded-JSON"),n,o=q.getResponseHeader("content-type").split(";")[0],m;if(p){n=JSON.parse(p);if(n.status==401){if(f.event.unauthorized.execute(href,n.headers?n.headers.location:null)!==false){if(n.headers&&n.headers.location){document.location=n.headers.location}}}}f.event.form.submit.after.execute(g,r,s,q);if(o=="application/json"){a.deal.json(r)}else{if(i&&i[0]!="_"){m=new c.view(f.viewer.inner.name,0,h,a.form.serialize(j),r);f.viewer.inner.replaceLastView(i,m)}else{m=f.viewer.manager.get().getView();f.viewer.manager.get().replaceLastView(new c.view(m.name,m.index,h,a.form.serialize(j),r))}e.refresh()}f.event.form.submit.completed.execute(g)}).fail(function(m,o,n){l.hide();$app.alert($(m.responseText).eq(1).text(),m.statusText)});return false}},initialization:function(g,h){if(!!window.ActiveXObject||"ActiveXObject" in window){$.ajaxSetup({cache:false})}$(document).on("click","a",a.click);$(document).on("submit","form",a.form.submit);$(document).on("click",".webapp-close",function(i){i.preventDefault();e.viewClose($(this).attr("data-close"))});$(document).on("change","form input[type=file][data-image]",a.form.image);e.configEvent().refresh(e.resetWindowScrollBar);e.configEvent().refresh(e.dealScrollToVisibleLoading);$(window).on("scroll",e.refresh);$(window).on("resize",e.refresh);$(document).on("touchmove",c.dealTouchMove);f.defaultHref=h;f.viewer.window=new c.windowViewer();f.viewer.main=new c.mainViewer(g);f.viewer.manager.push(f.viewer.main);f.event.initialled.execute();return f.option}};f={hasSetup:false,hideMainViewFirstLoadingTips:false,replacePCScrollBar:false,defaultHref:null,viewer:{main:null,window:null,manager:new c.viewerManager(),inner:new c.innerViewer()},event:{initialled:new c.action(),globalView:new c.viewEvent(),loadedView:new c.viewEvent(),loadTimeout:new c.action(),unauthorized:new c.action(),refresh:new c.action(),visibleLoaded:new c.action(),form:{dealCustomized:new c.action(),verify:new c.actionEvent(),submit:new c.actionEvent()}},windowScrollBar:null,hrefTargetDealer:{_link:function(g){e.linker.link(g)},_add:function(g){e.linker.add(g)},_same:function(g){e.linker.same(g)},_open:function(g){e.openWindow(g)}},option:new function(){this.defaultHref=function(g){if(!g){return f.defaultHref}f.defaultHref=g;return this};this.unauthorized=function(g){f.event.unauthorized.add(g);return this};this.loadTimeout=function(g){f.event.loadTimeout.add(g);return this};this.replacePCScrollBar=function(g){f.replacePCScrollBar=g;return this};this.viewLoaded=function(g){f.event.globalView.load.add(g);return this};this.viewActived=function(g){f.event.globalView.active.add(g);return this};this.viewInactived=function(g){f.event.globalView.inactive.add(g);return this};this.viewUnloaded=function(g){f.event.globalView.unload.add(g);return this};this.visibleLoaded=function(g){f.event.visibleLoaded.add(g);return this}}};this.bodyManagement=new function(){var g=0;this.expand=function(){if(g==0){$("body").addClass("layout-expanded");if(f.windowScrollBar){f.windowScrollBar.reset()}}g++};this.shrink=function(){g--;if(g==0){$("body").removeClass("layout-expanded");if(f.windowScrollBar){f.windowScrollBar.reset()}}if(g<0){console.error("shrink error")}}};this.loadingTip=new function(){var g,i=false;function h(){if(g!=null){return}g=$("<div></div>").addClass("loading-background").addClass("box-background");var j=$("<div></div>").addClass("loading-box").addClass("box-panel"),k=$("<span></span>").text(b.text.loading);j.append(k);g.append($("<div></div>").addClass("layout-center").append($("<div></div>").addClass("layout-center-content").append(j)));g.prependTo($("body"))}this.show=function(){h();if(i){return this}e.bodyManagement.expand();g.stop(true,true);g.fadeIn(b.setting.loading_show_time);i=true;return this};this.hide=function(j){if(!i){return this}h();g.stop(true);g.fadeOut(b.setting.loading_hide_time,function(){e.bodyManagement.shrink();if(typeof(j)=="function"){j()}});i=false;return this}};this.dialog=new function(){var i=[],h=[];function g(){var j=$("<div></div>").addClass("dialog-box").addClass("box-panel");this.head=function(k){var l=$("<div></div>").addClass("dialog-header");l.append($("<h4></h4>").text(k));j.append(l)};this.body=function(l){var k=$("<div></div>").addClass("dialog-body");if(l.indexOf("\n")>-1){$.each(l.split("\n"),function(m,o){k.append($("<p></p>").text(o))})}else{k.text(l)}j.append(k)};this.footer=function(l){var m=$("<div></div>").addClass("dialog-footer");function k(n){this.set=function(q,p){var r=new c.action(),o=$("<button></button>").text(q).addClass(p);o.click(function(s){l.close(s,function(){r.execute()})});n.append(o);return new function(){this.setCallback=function(s){r.add(s)}}}}j.append(m);return new k(m)};this.getNode=function(){return j}}this.custom=function(l){var k=new c.shield(".dialog-ares",l,true,"dialog-background"),j=i.length,m=false;i[j]=k;k.event().close.before.add(function(){delete i[j]});k.click(function(){if(!m){k.close()}});return new function(){this.close=function(n){k.close(null,n)};this.force=function(){m=true;return this}}};this.alert=function(n,o){var p,j=new g(),m,l=i.length;function k(q){this.ok=function(r){q.setCallback(r);return this}}if(o){j.head(o)}j.body(n);m=new c.shield(".dialog-ares",j.getNode(),true,"dialog-background");i[l]=m;m.event().close.before.add(function(){delete i[l]});p=j.footer(m).set(b.text.ok,"ok");return new k(p)};this.confirm=function(n,o){var p,j=new g(),m,l=i.length;function k(r,q){this.yes=function(s){r.setCallback(s);return this};this.no=function(s){q.setCallback(s);return this}}if(o){j.head(o)}j.body(n);m=new c.shield(".dialog-ares",j.getNode(),true,"dialog-background");i[l]=m;m.event().close.before.add(function(){delete i[l]});p=j.footer(m);return new k(p.set(b.text.yes,"yes"),p.set(b.text.no,"no"))};this.message=function(k){if(arguments.length==0){if(h.length==0){return null}return h[h.length-1]}var j=new g(),l;j.body(k);l=e.dialog.custom(j.getNode());return new function(){this.close=function(m){l.close(m);h.pop()};this.change=function(m){j.getNode().find(".dialog-body").text(m)};h.push(this)}};this.clear=function(){var j;for(j in i){i[j].close()}i=[]}};this.linker=new function(){var g=false,l=null,j=new c.action(),m=null;function h(n){if(!n){return n}if(n.substr(0,1)=="#"){return n.substr(1)}return n}function k(){j.execute(l)}function i(){var n=new a.linkParser(window.location.hash).getHash();if(l==n){return}l=n;k()}this.setChangeCompleted=function(n){if(typeof(n)!="function"){return}m=n};this.callChangeCompleted=function(n){if(!m){return}m(n);m=null};this.createHref=function(n){var p=new a.linkParser(n).getHash(),o=document.location.origin+document.location.pathname;if(p==""){return o}return o+"#"+p};this.createHash=function(n){return new a.linkParser(n).getHash()};this.hrefs=function(){return new a.linkParser(window.location.hash).getHrefs()};this.modify=function(n){window.location.hash=n;l=new a.linkParser(n).getHash()};this.hash=function(n){if(n==undefined){return window.location.hash}window.location.hash=n;if(n==l){k()}return n};this.link=function(){if(arguments.length==0){return f.viewer.manager.get().href}var n=new a.linkParser(Array.from(arguments)),o;o=n.getHash();window.location.hash=o;if(o==l){k()}};this.add=function(n){var o=new a.linkParser(window.location.hash);o.add(n);window.location.hash=o.getHash()};this.back=function(){var n=new a.linkParser(window.location.hash);if(n.count()==1){return}n.pop();window.location.hash=n.getHash()};this.same=function(n){var o=new a.linkParser(window.location.hash);o.last(n);window.location.hash=o.getHash();if(o.getHash()==l){k()}};this.refresh=function(){k()};this.onChange=function(n){j.add(n);if(g){return}g=true;l=h(window.location.hash);if("onhashchange" in window){window.onhashchange=i}else{window.setInterval(function(){if(l!=h(window.location.hash)){i()}},100)}k()}};this.form=a.form;this.linkEncode=function(g){if(!g){return""}if(g.indexOf("#")==0){return g.substr(1,g.length-1)}return g.replace(/\(/g,"(9)").replace(/\?/g,"(0)").replace(/\//g,"(1)").replace(/_/g,"(2)").replace(/#/g,"(3)").replace(/&/g,"(4)")};this.linkDecode=function(g){if(!g){return""}return g.replace(/\(0\)/g,"?").replace(/\(1\)/g,"/").replace(/\(2\)/g,"_").replace(/\(3\)/g,"#").replace(/\(4\)/g,"&").replace(/\(9\)/g,"(")};this.redirect=function(g,h){return f.viewer.manager.get().redirect(g,h)};this.openWindow=function(g,h){return f.viewer.window.open(g,h)};this.modalWindow=function(g,h){return f.viewer.window.modal(g,h)};this.viewClose=function(){return f.viewer.manager.get().close()};this.viewReload=function(g){return f.viewer.manager.get().reload(g)};this.viewEvent=function(){return new function(){this.onLoad=function(g){f.event.loadedView.load.add(g);return this};this.onUnload=function(g){f.event.loadedView.unload.add(g);return this};this.onActive=function(g){f.event.loadedView.active.add(g);return this};this.onInactive=function(g){f.event.loadedView.inactive.add(g);return this}}};this.currentViewNode=function(){var g=f.viewer.manager.get().getView();if(g==null){return null}return g.node};this.currentViewNodeFind=function(g){return e.currentViewNode().find(g)};this.resetWindowScrollBar=function(){if(f.windowScrollBar){f.windowScrollBar.reset();return}if("ontouchmove" in document){return}if(!f.replacePCScrollBar){return}f.windowScrollBar=new c.scrollBar("body")};this.dealScrollToVisibleLoading=function(g){var j,i,h;if(!e.currentViewNode()){return}if(g&&typeof(g.find)=="function"){j=g.find(".webapp-loading:visible").first()}else{j=$(".webapp-loading:visible").first()}if(e.currentViewNode().hasClass("open-view")){h=-e.currentViewNode().position().top}else{h=$(window).scrollTop()}if(j.length>0&&!j.data("work")&&h+$(window).height()>j.offset().top){j.data("work",true);i=j.attr("data-src");if(!i){return}$.get(i,function(k){j.before(k);j.remove();e.refresh(g);f.event.visibleLoaded.action()})}};this.refresh=function(g){f.event.refresh.execute(g)};this.configEvent=function(){return new function(){this.refresh=function(g){f.event.refresh.add(g)};this.formDealCustomized=function(g){f.event.form.dealCustomized.add(g)};this.formSubmit=function(){return f.event.form.submit};this.formVerify=function(){return f.event.form.verify}}};this.configSetting=function(g){if(typeof(g)=="function"){g(b.setting)}};this.configText=function(g){if(typeof(g)=="function"){g(b.text)}};this.configTarget=function(g){if(typeof(g)=="function"){g(f.hrefTargetDealer)}};this.option=function(){return f.option};this.initialled=function(g){f.event.initialled.add(g)};this.setup=function(i,j,h){if(!f.hasSetup){f.hasSetup=true}else{throw new Error("Has been setup")}var g=a.initialization(i,j);$(function(){if(h){f.hideMainViewFirstLoadingTips=true}e.linker.onChange(f.viewer.main.linkerChange)});return g};this.setupLayout=function(h,i,j,k){if(!f.hasSetup){f.hasSetup=true}else{throw new Error("Has been setup")}var g=a.initialization(j,k);$(function(){$.ajax({mimeType:"text/html; charset="+b.setting.server_charset,url:i,type:"GET",timeout:b.setting.timeover}).done(function(o,p,n){var l=n.getResponseHeader("X-Responded-JSON"),m;if(l){m=JSON.parse(l);if(m.status==401){if(f.event.unauthorized.execute(i,m.headers?m.headers.location:null)!==false){if(m.headers&&m.headers.location){document.location=m.headers.location}}return}}if(a.isHtmlDocument(o)){alert("You try to load wrong content: "+i);return}$(h).html(o).children().unwrap();f.hideMainViewFirstLoadingTips=true;e.linker.onChange(f.viewer.main.linkerChange)}).fail(function(l,n,m){if(l.status==401){if(f.event.unauthorized.execute(i)===false){return}}else{if(l.status==0&&n=="timeout"){f.event.loadTimeout.execute($(h));return}}e.dialog.alert(b.text.load_layout_error,m).ok(function(){document.location.reload()})})});return g};window.$app={configSetting:e.configSetting,configText:e.configText,configEvent:e.configEvent,util:{delay:new c.delay(),loader:new c.loader()},alert:e.dialog.alert,confirm:e.dialog.confirm,message:e.dialog.message,loading:function(){return e.loadingTip.show()},hash:e.linker.hash,link:e.linker.link,add:e.linker.add,same:e.linker.same,open:e.openWindow,modal:e.modalWindow,reload:e.viewReload,close:e.viewClose,event:e.viewEvent,current:e.currentViewNode,find:e.currentViewNodeFind,option:e.option,setup:e.setup,setupLayout:e.setupLayout}})();